
let lines = [];
let index = 0;

function confirmInput() {
  const text = document.getElementById('inputText').value;
  lines = text.split('\n').map(line => line.trim()).filter(line => line);
  index = 0;
  if (lines.length > 0) {
    localStorage.setItem('savedLines', JSON.stringify(lines));
    localStorage.setItem('savedIndex', index);
    document.getElementById('genBtn').style.display = 'inline-block';
    document.getElementById('prevBtn').style.display = 'inline-block';
    document.getElementById('copyAllBtn').style.display = 'inline-block';
    updateStatus();
  } else {
    alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ù†ØµÙˆØµ Ø£ÙˆÙ„Ø§Ù‹.');
  }
}

function copyNext() {
  while (index < lines.length && !lines[index].trim()) index++; // Skip empty lines
  if (index < lines.length) {
    navigator.clipboard.writeText(lines[index]).then(() => {
      flashElement('genBtn');
      index++;
      localStorage.setItem('savedIndex', index);
      updateStatus();
    }).catch((err) => {
      alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®! ÙŠØ±Ø¬Ù‰ Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.");
      console.error("Clipboard error:", err);
    });
  } else {
    alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
  }
}

function copyPrev() {
  if (index > 1) {
    index -= 2;
    localStorage.setItem('savedIndex', index);
    copyNext();
  } else if (index === 1) {
    index = 0;
    localStorage.setItem('savedIndex', index);
    copyNext();
  } else {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø·Ø± Ø³Ø§Ø¨Ù‚.');
  }
}

function copyByNumber() {
  const userInput = prompt(`Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± (Ù…Ù† 1 Ø¥Ù„Ù‰ ${lines.length}):`);
  const lineNum = parseInt(userInput);
  if (!isNaN(lineNum) && lineNum >= 1 && lineNum <= lines.length) {
    index = lineNum - 1;
    localStorage.setItem('savedIndex', index);
    copyNext();
  } else {
    alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­.");
  }
}

function copyAll() {
  if (lines.length > 0) {
    navigator.clipboard.writeText(lines.join('\n')).then(() => {
      flashElement('copyAllBtn');
      alert('ØªÙ… Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø·ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');
    }).catch(() => {
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„.');
    });
  }
}

function resetAll() {
  document.getElementById('inputText').value = '';
  document.getElementById('status').innerText = '';
  document.getElementById('genBtn').style.display = 'none';
  document.getElementById('prevBtn').style.display = 'none';
  document.getElementById('copyAllBtn').style.display = 'none';
  document.getElementById('resumeBtn').style.display = 'none';
  document.getElementById('progressFill').style.width = '0%';
  lines = [];
  index = 0;
  localStorage.removeItem('savedLines');
  localStorage.removeItem('savedIndex');
}

function updateStatus() {
  const percent = (index / lines.length) * 100;
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('status').innerText = `ğŸ“Œ ØªÙ… Ø§Ù„Ù†Ø³Ø®: ${index} Ù…Ù† ${lines.length}`;
}

function toggleMode() {
  document.body.classList.toggle('light-mode');
  const mode = document.body.classList.contains('light-mode') ? 'light' : 'dark';
  localStorage.setItem('mode', mode);
}

function resumeSession() {
  const saved = localStorage.getItem('savedLines');
  const savedIdx = localStorage.getItem('savedIndex');
  if (saved) {
    lines = JSON.parse(saved);
    index = savedIdx !== null ? parseInt(savedIdx) : 0;
    document.getElementById('inputText').value = lines.join('\n');
    document.getElementById('genBtn').style.display = 'inline-block';
    document.getElementById('prevBtn').style.display = 'inline-block';
    document.getElementById('copyAllBtn').style.display = 'inline-block';
    document.getElementById('resumeBtn').style.display = 'none';
    updateStatus();
  } else {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.");
  }
}

function flashElement(id) {
  const el = document.getElementById(id);
  el.classList.add('flash-effect');
  setTimeout(() => el.classList.remove('flash-effect'), 300);
}

window.onload = function () {
  document.getElementById('inputText').focus();

  const savedMode = localStorage.getItem('mode');
  if (savedMode === 'light') {
    document.body.classList.add('light-mode');
  }

  const saved = localStorage.getItem('savedLines');
  if (saved) {
    document.getElementById('resumeBtn').style.display = 'inline-block';
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      if (e.shiftKey) copyPrev();
      else copyNext();
    }
    if (e.ctrlKey && e.altKey && e.key === 'c') copyAll();
  });
};



document.addEventListener("DOMContentLoaded", () => {
  const isArabic = document.documentElement.lang === "ar" || document.body.dir === "rtl";
  const clipboardPermission = localStorage.getItem("clipboardPermission");

  // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø°Ù† Ù…Ù…Ù†ÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„
  if (clipboardPermission === "granted") return;

  // Ø¯Ø§Ù„Ø© Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API
  async function tryClipboardWrite() {
    if (!navigator.clipboard) {
      return { success: false, error: "Clipboard API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…" };
    }
    try {
      await navigator.clipboard.writeText(" ");
      return { success: true };
    } catch (err) {
      return { success: false, error: err.message };
    }
  }

  // Ø¯Ø§Ù„Ø© Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… clipboard.js ÙƒØ¨Ø¯ÙŠÙ„
  function tryClipboardJsWrite() {
    return new Promise((resolve) => {
      if (typeof ClipboardJS === "undefined") {
        resolve({ success: false, error: "Ù…ÙƒØªØ¨Ø© Clipboard.js ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©" });
        return;
      }
      const clipboard = new ClipboardJS('.clipboard-btn', {
        text: () => " ",
      });
      clipboard.on('success', () => {
        clipboard.destroy();
        resolve({ success: true });
      });
      clipboard.on('error', (e) => {
        clipboard.destroy();
        resolve({ success: false, error: e.action + " ÙØ´Ù„" });
      });
      document.querySelector('.clipboard-btn').click();
    });
  }

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø¥Ø°Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©
  async function checkClipboardPermission() {
    if (navigator.permissions && navigator.permissions.query) {
      try {
        const permissionStatus = await navigator.permissions.query({ name: 'clipboard-write' });
        return permissionStatus.state; // 'granted', 'prompt', Ø£Ùˆ 'denied'
      } catch (err) {
        console.warn("ÙˆØ§Ø¬Ù‡Ø© Permissions ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø£Ùˆ ÙØ´Ù„Øª:", err);
        return 'unknown';
      }
    }
    return 'unknown';
  }

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
  function showPermissionPrompt() {
    Swal.fire({
      title: isArabic ? 'Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©ØŸ' : 'Allow clipboard access?',
      text: isArabic ? "Ù‡Ø°Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªÙ…ÙƒÙŠÙ† Ø®Ø§ØµÙŠØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ." : "This is needed for clipboard copy functionality.",
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: isArabic ? 'Ù†Ø¹Ù…ØŒ Ø§Ø³Ù…Ø­ Ø¨Ø°Ù„Ùƒ' : 'Yes, allow it',
      cancelButtonText: isArabic ? 'Ù„Ø§' : 'No',
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      didOpen: () => {
        if (isArabic) {
          const swal = document.querySelector('.swal2-popup');
          if (swal) swal.setAttribute("dir", "rtl");
        }
      }
    }).then(async (result) => {
      if (result.isConfirmed) {
        const permissionState = await checkClipboardPermission();

        if (permissionState === 'granted' || permissionState === 'prompt' || permissionState === 'unknown') {
          let writeResult = await tryClipboardWrite();

          // Ø¥Ø°Ø§ ÙØ´Ù„ Clipboard APIØŒ Ø¬Ø±Ø¨ clipboard.js
          if (!writeResult.success && typeof ClipboardJS !== "undefined") {
            writeResult = await tryClipboardJsWrite();
          }

          if (writeResult.success) {
            Swal.fire(
              isArabic ? 'ØªÙ…!' : 'Done!',
              isArabic ? 'ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.' : 'Clipboard access granted.',
              'success'
            );
            localStorage.setItem("clipboardPermission", "granted");
          } else {
            Swal.fire({
              title: isArabic ? 'Ø®Ø·Ø£!' : 'Error!',
              text: (isArabic ? 'ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©: ' : 'Failed to access clipboard: ') + writeResult.error,
              icon: 'error',
              showCancelButton: true,
              confirmButtonText: isArabic ? 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Try again',
              cancelButtonText: isArabic ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel',
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              didOpen: () => {
                if (isArabic) {
                  const swal = document.querySelector('.swal2-popup');
                  if (swal) swal.setAttribute("dir", "rtl");
                }
              }
            }).then((retryResult) => {
              if (retryResult.isConfirmed) {
                showPermissionPrompt(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
              } else {
                localStorage.setItem("clipboardPermission", "denied");
                Swal.fire(
                  isArabic ? 'Ù…Ù„Ø§Ø­Ø¸Ø©' : 'Note',
                  isArabic ? 'ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø© Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.' : 'You can enable clipboard access from your browser settings.',
                  'info'
                );
              }
            });
          }
        } else {
          Swal.fire(
            isArabic ? 'ØªÙ… Ø§Ù„Ø±ÙØ¶!' : 'Denied!',
            isArabic ? 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.' : 'Clipboard access permission was denied. You can enable it from browser settings.',
            'error'
          );
          localStorage.setItem("clipboardPermission", "denied");
        }
      } else {
        localStorage.setItem("clipboardPermission", "denied");
      }
    });
  }

  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù…Ø®ÙÙŠ Ù„Ù€ clipboard.js
  const btn = document.createElement("button");
  btn.className = "clipboard-btn";
  btn.style.display = "none";
  document.body.appendChild(btn);

  // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¥Ø°Ù† Ù…Ø±ÙÙˆØ¶Ù‹Ø§
  if (clipboardPermission !== "denied") {
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Clipboard API
    if (!navigator.clipboard && typeof ClipboardJS === "undefined") {
      Swal.fire(
        isArabic ? 'ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…!' : 'Not supported!',
        isArabic ? 'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø­Ø§ÙØ¸Ø©.' : 'Your browser does not support clipboard functionality.',
        'warning'
      );
      localStorage.setItem("clipboardPermission", "denied");
    } else {
      showPermissionPrompt();
    }
  }
});
